<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef Performance | AI Eats</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="logo">AI Eats</div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="chef-dashboard.html">My Orders</a></li>
            <li><a href="chef-ratings.html" class="active">My Performance</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="#" id="logout-btn">Logout</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <h1> Your Performance & Ratings</h1>

        <!-- Performance Summary -->
        <div class="performance-card">
            <h2>Performance Summary</h2>
            <div class="performance-grid">
                <div class="perf-item">
                    <div class="perf-label">Average Rating</div>
                    <div class="perf-value" id="avg-rating">--</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Total Complaints</div>
                    <div class="perf-value" id="complaint-count">--</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Total Compliments</div>
                    <div class="perf-value" id="compliment-count">--</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Net Complaints</div>
                    <div class="perf-value" id="net-complaints">--</div>
                </div>
            </div>
        </div>

        <!-- Status Message -->
        <div id="status-message" class="status-card" style="display: none;">
            <h3 id="status-title"></h3>
            <p id="status-text"></p>
        </div>

        <!-- UC-02 A3: Rating Requirements -->
        <div class="requirements-card">
            <h2>[*] Performance Criteria (UC-02 A3)</h2>
            <div class="criteria-grid">
                <div class="criteria-item demotion">
                    <h4>Demotion Criteria</h4>
                    <p>• Average rating &lt; 2.0 stars, OR</p>
                    <p>• Net complaints ≥ 3</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        First demotion: Role becomes "Demoted_Chef"<br/>
                        Second demotion: Terminated
                    </p>
                </div>
                <div class="criteria-item bonus">
                    <h4> Bonus Criteria</h4>
                    <p> Average rating &gt; 4.0 stars, OR</p>
                    <p> Compliments ≥ 3</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        Receive performance bonus and recognition
                    </p>
                </div>
            </div>
        </div>

        <!-- Recent Reviews -->
        <div class="reviews-section">
            <h2>Recent Reviews</h2>
            <div id="reviews-list">
                <p>Loading reviews...</p>
            </div>
        </div>

        <!-- Check Performance Button -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn-primary" onclick="checkPerformance()" style="padding: 15px 30px; font-size: 16px;">
                Check My Performance Status
            </button>
        </div>
    </div>

    <!-- Performance Result Modal -->
    <div id="performance-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Performance Evaluation Result</h3>
                <span class="close" onclick="closePerformanceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="performance-result"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closePerformanceModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:5000/api";
        let currentUser = null;

        // Check if user is logged in as Chef
        function checkAuth() {
            const token = localStorage.getItem("token");
            const userId = localStorage.getItem("user_id");
            const role = localStorage.getItem("role");

            if (!token || !userId) {
                alert("Please log in first.");
                window.location.href = "login.html";
                return null;
            }

            if (role !== "Chef") {
                alert("Unauthorized. Only chefs can access this page.");
                window.location.href = "index.html";
                return null;
            }

            return { token, userId, role };
        }

        // Load chef performance data
        async function loadPerformanceData() {
            try {
                // Get complaints and compliments about this chef
                const complaintResponse = await fetch(`${API_BASE}/complaints/received/${currentUser.userId}`, {
                    headers: {
                        "Authorization": `Bearer ${currentUser.token}`
                    }
                });

                if (!complaintResponse.ok) {
                    console.error("Failed to fetch complaints");
                    return;
                }

                const complaints = await complaintResponse.json();
                displayPerformanceData(complaints);
            } catch (error) {
                console.error("Error loading performance data:", error);
            }
        }

        // Display performance data
        function displayPerformanceData(complaints) {
            if (!complaints || complaints.length === 0) {
                document.getElementById("avg-rating").textContent = "N/A";
                document.getElementById("complaint-count").textContent = "0";
                document.getElementById("compliment-count").textContent = "0";
                document.getElementById("net-complaints").textContent = "0";
                return;
            }

            // Filter by valid complaints/compliments
            const validComplaints = complaints.filter(c => c.status === "Valid" && c.is_complaint);
            const validCompliments = complaints.filter(c => c.status === "Valid" && !c.is_complaint);

            // Calculate average rating
            const ratings = complaints
                .filter(c => c.rating > 0)
                .map(c => c.rating);
            const avgRating = ratings.length > 0 
                ? (ratings.reduce((a, b) => a + b) / ratings.length).toFixed(2)
                : "N/A";

            // Calculate net complaints
            const netComplaints = validComplaints.length - validCompliments.length;

            // Update display
            document.getElementById("avg-rating").textContent = avgRating;
            document.getElementById("complaint-count").textContent = validComplaints.length;
            document.getElementById("compliment-count").textContent = validCompliments.length;
            document.getElementById("net-complaints").textContent = netComplaints;

            // Display recent reviews
            displayReviews(complaints.slice(0, 10));

            // Show status message if near threshold
            showStatusMessage(avgRating, netComplaints, validCompliments.length);
        }

        // Display recent reviews
        function displayReviews(reviews) {
            const container = document.getElementById("reviews-list");

            if (!reviews || reviews.length === 0) {
                container.innerHTML = "<p>No reviews yet</p>";
                return;
            }

            container.innerHTML = reviews.map(review => `
                <div class="review-card ${review.status.toLowerCase()}">
                    <div class="review-header">
                        <span class="review-type ${review.is_complaint ? 'complaint' : 'compliment'}">
                            ${review.is_complaint ? '[DISLIKE] Complaint' : '[LIKE] Compliment'}
                        </span>
                        <span class="review-rating">
                            ${review.rating > 0 ? '[*]'.repeat(review.rating) + '[o]'.repeat(5 - review.rating) : 'N/A'}
                        </span>
                    </div>
                    <div class="review-content">
                        <p><strong>From:</strong> ${review.from_name}</p>
                        <p><strong>Message:</strong> ${review.text || 'No message'}</p>
                        <p class="review-date"> ${new Date(review.created_at).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        }

        // Show status message
        function showStatusMessage(avgRating, netComplaints, compliments) {
            const statusMsg = document.getElementById("status-message");
            const statusTitle = document.getElementById("status-title");
            const statusText = document.getElementById("status-text");

            // Check demotion threshold
            if (avgRating !== "N/A" && avgRating < 2.0) {
                statusMsg.className = "status-card danger";
                statusTitle.textContent = "[WARNING] CRITICAL: Low Ratings";
                statusText.textContent = `Your average rating (${avgRating}) is below 2.0 stars. You are at risk of demotion. Improve your performance immediately!`;
                statusMsg.style.display = "block";
                return;
            }

            if (netComplaints >= 3) {
                statusMsg.className = "status-card danger";
                statusTitle.textContent = "[WARNING] CRITICAL: High Complaints";
                statusText.textContent = `You have ${netComplaints} net complaints. You are at risk of demotion. Resolve complaints and improve service!`;
                statusMsg.style.display = "block";
                return;
            }

            // Check bonus threshold
            if (avgRating !== "N/A" && avgRating > 4.0) {
                statusMsg.className = "status-card success";
                statusTitle.textContent = "[CONGRATS] Excellent Performance!";
                statusText.textContent = `Your average rating (${avgRating}) is excellent! You may be eligible for a performance bonus.`;
                statusMsg.style.display = "block";
                return;
            }

            if (compliments >= 3) {
                statusMsg.className = "status-card success";
                statusTitle.textContent = "[CONGRATS] Excellent Feedback!";
                statusText.textContent = `You have received ${compliments} compliments! You may be eligible for a performance bonus.`;
                statusMsg.style.display = "block";
                return;
            }

            // Good standing
            if (netComplaints <= 1) {
                statusMsg.className = "status-card info";
                statusTitle.textContent = "[OK] Good Standing";
                statusText.textContent = "Your performance is satisfactory. Keep maintaining high quality!";
                statusMsg.style.display = "block";
            }
        }

        // Check performance evaluation
        async function checkPerformance() {
            try {
                const response = await fetch(`${API_BASE}/chefs/performance/${currentUser.userId}`, {
                    headers: {
                        "Authorization": `Bearer ${currentUser.token}`
                    }
                });

                if (!response.ok) {
                    throw new Error("Failed to fetch performance evaluation");
                }

                const result = await response.json();
                displayPerformanceResult(result);
                document.getElementById("performance-modal").style.display = "flex";
            } catch (error) {
                console.error("Error checking performance:", error);
                alert(`Error: ${error.message}`);
            }
        }

        // Display performance result
        function displayPerformanceResult(result) {
            const container = document.getElementById("performance-result");

            let actionIcon = "";
            let actionColor = "#2196F3";

            if (result.action === "demoted") {
                actionIcon = "[HOLD]";
                actionColor = "#F44336";
            } else if (result.action === "terminated") {
                actionIcon = "[ERROR]";
                actionColor = "#C62828";
            } else if (result.action === "bonus") {
                actionIcon = "[BONUS]";
                actionColor = "#4CAF50";
            }

            container.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="font-size: 48px; margin: 0;">${actionIcon}</h2>
                    <h3 style="color: ${actionColor}; margin-top: 10px;">
                        ${result.message || "Performance Evaluated"}
                    </h3>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                    <h4>Performance Metrics:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <p><strong>Average Rating:</strong> ${result.avg_rating}/5.0</p>
                            <p><strong>Complaints:</strong> ${result.complaint_count}</p>
                        </div>
                        <div>
                            <p><strong>Compliments:</strong> ${result.compliment_count}</p>
                            <p><strong>Net Complaints:</strong> ${result.net_complaints}</p>
                        </div>
                    </div>
                </div>

                ${result.action === "demoted" ? `
                    <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-left: 4px solid #F44336; border-radius: 4px;">
                        <strong style="color: #C62828;">Demotion Notice:</strong>
                        <p>Your role has been changed to "Demoted_Chef" due to poor performance. You have one opportunity to improve before termination.</p>
                    </div>
                ` : ""}

                ${result.action === "terminated" ? `
                    <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-left: 4px solid #C62828; border-radius: 4px;">
                        <strong style="color: #C62828;">Termination Notice:</strong>
                        <p>Your employment has been terminated due to repeated poor performance. Please contact the manager for details.</p>
                    </div>
                ` : ""}

                ${result.action === "bonus" ? `
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                        <strong style="color: #2e7d32;">Bonus Awarded!</strong>
                        <p>Congratulations! You have been awarded a performance bonus for your excellent service and high ratings.</p>
                    </div>
                ` : ""}
            `;
        }

        // Close modal
        function closePerformanceModal() {
            document.getElementById("performance-modal").style.display = "none";
        }

        // Logout
        document.getElementById("logout-btn").addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = "login.html";
        });

        // Initialize
        currentUser = checkAuth();
        if (currentUser) {
            loadPerformanceData();
        }
    </script>

    <style>
        .performance-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .perf-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .perf-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .perf-value {
            font-size: 32px;
            font-weight: bold;
        }

        .status-card {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 5px solid;
        }

        .status-card.danger {
            background: #ffebee;
            border-left-color: #F44336;
            color: #C62828;
        }

        .status-card.success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
            color: #2e7d32;
        }

        .status-card.info {
            background: #e3f2fd;
            border-left-color: #2196F3;
            color: #1565c0;
        }

        .status-card h3 {
            margin-top: 0;
        }

        .requirements-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .criteria-item {
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid;
        }

        .criteria-item.demotion {
            background: #fff3e0;
            border-left-color: #F57C00;
        }

        .criteria-item.bonus {
            background: #f3e5f5;
            border-left-color: #7B1FA2;
        }

        .criteria-item h4 {
            margin-top: 0;
        }

        .reviews-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .review-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #2196F3;
        }

        .review-card.valid {
            border-left-color: #4CAF50;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .review-type {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .review-type.complaint {
            background: #ffebee;
            color: #c62828;
        }

        .review-type.compliment {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .review-rating {
            color: #FF9800;
            font-weight: bold;
        }

        .review-content p {
            margin: 8px 0;
            font-size: 14px;
        }

        .review-date {
            color: #999;
            font-size: 12px;
        }

        .modal-content {
            max-width: 600px;
        }
    </style>
</body>
</html>
