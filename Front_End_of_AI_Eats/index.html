<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>AI Eats - Home</title>
 <link rel="stylesheet" href="style.css">
</head>
<body>

 <!-- HEADER -->
 <header>
   <h1>AI Eats</h1>

   <nav>
     <div class="nav-left">
       <a href="login.html" id="auth-link">Login/Register</a>
       <a href="#" id="dashboard-link" style="display: none; margin-left: 15px; background-color: #ff6b6b; color: white; padding: 8px 15px; border-radius: 5px; font-weight: bold;">Dashboard</a>
     </div>

     <div class="nav-center">
       <a href="index.html">Home</a>
       <a href="#" id="menu-link">Menu</a>
       <a href="#" id="chat-link">AI Chat</a>
       <a href="complaints.html" id="ratings-link">Ratings</a>
     </div>

     <div class="nav-right">
       <a href="cart.html" id="cart-link"> Cart (<span id="cart-count">0</span>)</a>
     </div>
   </nav>
 </header>

 <!-- UC-05: VISITOR MENU BROWSING SECTION -->
 <section class="home-section" id="visitor-menu-section" style="display: none;">
  <h2>Browse Our Menu</h2>
  <div class="menu-filter">
    <input type="text" id="search-box" placeholder="Search dishes...">
    <select id="category-filter">
      <option value="">All Categories</option>
      <option value="pizza">Pizza</option>
      <option value="burgers">Burgers</option>
      <option value="asian">Asian</option>
      <option value="healthy">Healthy</option>
      <option value="desserts">Desserts</option>
      <option value="drinks">Drinks</option>
    </select>
  </div>
  <div class="menu-grid" id="visitor-menu-grid"></div>
  <div id="no-menu" class="empty-state" style="display: none;">
    <p>No dishes found. Please try a different search.</p>
  </div>
 </section>

 <!-- ORDER TRACKING SECTION (for logged-in users) -->
 <section class="home-section" id="orders-section" style="display: none;">
  <h2>Your Orders</h2>
  <div id="vip-banner" style="display: none; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f57f17, #fbc02d); border-radius: 8px; color: white; text-align: center;">
    <h3>Congratulations!</h3>
    <p>You've earned VIP status! Enjoy <strong>10% discounts</strong>, <strong>free delivery</strong>, and <strong>exclusive dishes</strong>!</p>
    <a href="vip-dashboard.html" style="color: white; text-decoration: underline; font-weight: bold;">View VIP Benefits</a>
  </div>
  <div class="orders-container">
    <div id="orders-list"></div>
    <div id="no-orders" class="empty-state" style="display: none;">
      <p>No orders yet. <a href="#" onclick="loadVisitorMenu(); return false;">Start ordering now!</a></p>
    </div>
  </div>
 </section>

 <!-- HERO SECTION -->
 <section class="hero">
   <h2>Delicious Food, AI-Powered Service</h2>
   <p class="hero-subtitle">Fast delivery ‚Ä¢ Fresh ingredients ‚Ä¢ AI recommendations</p>
   <a href="menu.html" class="btn">Browse Menu</a>
 </section>

 <!-- DELIVERY INFO -->
 <section class="delivery-info">
   <div class="info-cards">
     <div class="info-card">
       <div class="info-icon">üöö</div>
       <h4>Fast Delivery</h4>
       <p>30-45 min delivery</p>
     </div>
     <div class="info-card">
       <div class="info-icon">[DINING]</div>
       <h4>Fresh Food</h4>
       <p>Made to order</p>
     </div>
     <div class="info-card">
       <div class="info-icon">ü§ñ</div>
       <h4>AI Powered</h4>
       <p>Smart recommendations</p>
     </div>
     <div class="info-card">
       <div class="info-icon">[*]</div>
       <h4>Top Rated</h4>
       <p>4.8/5 stars</p>
     </div>
   </div>
 </section>

 <!-- CATEGORIES -->
 <section class="categories-section">
   <h2>Browse by Category</h2>
   <div class="categories-grid">
     <div class="category-card">
       <div class="category-icon"></div>
       <h4>Pizza</h4>
     </div>
     <div class="category-card">
       <div class="category-icon">üçî</div>
       <h4>Burgers</h4>
     </div>
     <div class="category-card">
       <div class="category-icon">üçú</div>
       <h4>Asian</h4>
     </div>
     <div class="category-card">
       <div class="category-icon">ü•ó</div>
       <h4>Healthy</h4>
     </div>
     <div class="category-card">
       <div class="category-icon">üç∞</div>
       <h4>Desserts</h4>
     </div>
     <div class="category-card">
       <div class="category-icon">‚òï</div>
       <h4>Drinks</h4>
     </div>
   </div>
 </section>

 <!-- PROMOTIONS -->
 <section class="promotions-section">
   <h2>Special Offers</h2>
   <div class="promotions-grid">
     <div class="promo-card">
       <div class="promo-badge">20% OFF</div>
       <h4>First Order Discount</h4>
       <p>Get 20% off your first order with code WELCOME20</p>
       <span class="promo-code">Code: WELCOME20</span>
     </div>
     <div class="promo-card vip-promo">
       <div class="promo-badge">VIP</div>
       <h4>Free Delivery Forever</h4>
       <p>Join VIP membership and never pay delivery fees again</p>
       <a href="vip-membership.html" class="promo-btn">Join VIP</a>
     </div>
   </div>
 </section>

 <!-- POPULAR DISHES SECTION -->
<section class="home-section">
  <h2>Most Popular Dishes</h2>
  <div class="menu-grid">
    <div class="menu-card">
      <img src="images/burger.jpeg" alt="Cheese Burger">
      <h3>Cheese Burger</h3>
      <p>Juicy beef burger with cheese and fresh lettuce.</p>
      <div class="dish-rating">
        <span class="stars">[*][*][*][*][*]</span>
        <span class="rating-text">4.8 (324 reviews)</span>
      </div>
      <span class="price">$9.99</span>
    </div>

    <div class="menu-card">
      <img src="images/sushi.jpeg" alt="Salmon Sushi">
      <h3>Salmon Sushi</h3>
      <p>Fresh salmon with perfectly seasoned rice.</p>
      <div class="dish-rating">
        <span class="stars">[*][*][*][*][*]</span>
        <span class="rating-text">4.9 (189 reviews)</span>
      </div>
      <span class="price">$14.99</span>
    </div>

    <div class="menu-card">
      <img src="images/pasta.jpeg" alt="Fettuccine Alfredo">
      <h3>Fettuccine Alfredo</h3>
      <p>Creamy pasta with parmesan cheese and herbs.</p>
      <div class="dish-rating">
        <span class="stars">[*][*][*][*][o]</span>
        <span class="rating-text">4.7 (156 reviews)</span>
      </div>
      <span class="price">$12.99</span>
    </div>
  </div>
</section>

<!-- VIP SECTION -->
<section class="vip-section" id="vip-section">
  <h2>VIP Specials</h2>
  <div id="vip-content">
    <div class="menu-grid">
      <div class="menu-card">
        <img src="images/lobster.jpeg" alt="Grilled Lobster">
        <h3>Grilled Lobster</h3>
        <p>Succulent lobster grilled to perfection.</p>
        <div class="dish-rating">
          <span class="stars">[*][*][*][*][*]</span>
          <span class="rating-text">4.9 (87 reviews)</span>
        </div>
        <span class="vip-badge">VIP</span>
        <span class="price">$35.99</span>
      </div>

      <div class="menu-card">
        <img src="images/ribeye.jpeg" alt="Ribeye Steak">
        <h3>Ribeye Steak</h3>
        <p>Juicy ribeye steak, perfectly seared.</p>
        <div class="dish-rating">
          <span class="stars">[*][*][*][*][*]</span>
          <span class="rating-text">4.8 (112 reviews)</span>
        </div>
        <span class="vip-badge">VIP</span>
        <span class="price">$29.99</span>
      </div>

      <div class="menu-card">
        <img src="images/tomahawk.jpeg" alt="Tomahawk Steak">
        <h3>Tomahawk Steak</h3>
        <p>Premium tomahawk cut with rich marbling.</p>
        <div class="dish-rating">
          <span class="stars">[*][*][*][*][*]</span>
          <span class="rating-text">5.0 (43 reviews)</span>
        </div>
        <span class="vip-badge">VIP</span>
        <span class="price">$49.99</span>
      </div>
    </div>
  </div>
  
  <div id="vip-locked" class="vip-locked" style="display: none;">
    <div class="lock-icon">üîí</div>
    <h3>VIP Members Only</h3>
    <p>Unlock exclusive premium dishes with VIP membership</p>
    <a href="vip-membership.html" class="btn vip-upgrade-btn">Upgrade to VIP - $9.99/month</a>
  </div>
</section>

<!-- REVIEWS -->
<section class="home-section reviews">
  <h2>What Our Customers Say</h2>
  <div class="reviews-grid">
    <div class="review-card">
      <div class="review-stars">[*][*][*][*][*]</div>
      <p>"Amazing food and super fast delivery! Highly recommend AI Eats."</p>
      <span>- Sarah M.</span>
    </div>

    <div class="review-card">
      <div class="review-stars">[*][*][*][*][*]</div>
      <p>"VIP specials are worth every penny. Love the personalized AI recommendations."</p>
      <span>- James K.</span>
    </div>

    <div class="review-card">
      <div class="review-stars">[*][*][*][*][*]</div>
      <p>"The AI chat helped me decide my order easily. Great experience!"</p>
      <span>- Linda R.</span>
    </div>

    <div class="review-card">
      <div class="review-stars">[*][*][*][*][*]</div>
      <p>"Free delivery with VIP is a game changer. Food quality is consistently excellent."</p>
      <span>- Mike D.</span>
    </div>
  </div>
</section>

<!-- STATS SECTION -->
<section class="stats-section">
  <div class="stats-grid">
    <div class="stat-card">
      <h3>50K+</h3>
      <p>Happy Customers</p>
    </div>
    <div class="stat-card">
      <h3>30 min</h3>
      <p>Average Delivery</p>
    </div>
    <div class="stat-card">
      <h3>4.8‚òÖ</h3>
      <p>Customer Rating</p>
    </div>
    <div class="stat-card">
      <h3>24/7</h3>
      <p>Available</p>
    </div>
  </div>
</section>

<!-- DOWNLOAD APP -->
<section class="app-section">
  <div class="app-content">
    <div class="app-text">
      <h2>Get the AI Eats App</h2>
      <p>Order faster, track deliveries, and get exclusive app-only deals</p>
      <div class="app-buttons">
        <div class="app-btn">üì± Download for iOS</div>
        <div class="app-btn">ü§ñ Download for Android</div>
      </div>
    </div>
    <div class="app-image">üì±</div>
  </div>
</section>

<!-- CHAT CTA -->
<section class="home-section chat-cta">
  <h2>Need Help Choosing?</h2>
  <p>Ask our AI assistant for personalized recommendations!</p>
  <a href="chat.html" class="btn">Chat with AI</a>
</section>

<!-- FOOTER -->
<footer>
  <p>&copy; 2025 AI Eats. All rights reserved.</p>
  <p>
    <a href="#">Facebook</a> |
    <a href="#">Instagram</a> |
    <a href="#">Twitter</a>
  </p>
</footer>

<script src="js/index.js"></script>
  const API_URL = "http://127.0.0.1:5000";

  async function loadFeaturedDishes() {
    try {
      const response = await fetch(`${API_URL}/api/menu/`);
      if (response.ok) {
        const dishes = await response.json();
        const featured = dishes
          .filter(d => d.average_rating >= 4.5)
          .sort((a, b) => b.average_rating - a.average_rating)
          .slice(0, 3);
        
        console.log('Featured dishes loaded:', featured);
      }
    } catch (error) {
      console.error('Error loading featured dishes:', error);
    }
  }

  function updateCartCount() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById("cart-count").textContent = totalItems;
  }

  function updateAuthStatus() {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    const username = localStorage.getItem("username");
    const userRole = localStorage.getItem("userRole");
    const isVIP = localStorage.getItem("isVIP") === "true";
    const authLink = document.getElementById("auth-link");
    const dashboardLink = document.getElementById("dashboard-link");
    
    if (isLoggedIn === "true" && username) {
      const vipIcon = isVIP ? "[VIP] " : "";
      authLink.textContent = `[USER] ${vipIcon}${username}`;
      authLink.href = "profile.html";
      
      if (isVIP) {
        dashboardLink.style.display = "block";
        dashboardLink.href = "vip-dashboard.html";
        dashboardLink.textContent = "VIP Dashboard";
      } else if (userRole && userRole !== "Customer") {
        dashboardLink.style.display = "block";
        const dashboardMap = {
          "Manager": "manager-dashboard.html",
          "Chef": "chef-dashboard.html",
          "DeliveryPerson": "delivery-dashboard.html"
        };
        const linkTextMap = {
          "Manager": "Tasks",
          "Chef": "Orders",
          "DeliveryPerson": "Deliveries"
        };
        dashboardLink.href = dashboardMap[userRole] || "profile.html";
        dashboardLink.textContent = linkTextMap[userRole] || "Dashboard";
      }
    } else {
      authLink.textContent = "Login/Register";
      authLink.href = "login.html";
      dashboardLink.style.display = "none";
    }
  }

  function checkVIPAccess() {
    const isVIP = localStorage.getItem("isVIP") === "true";
    const vipContent = document.getElementById("vip-content");
    const vipLocked = document.getElementById("vip-locked");
    const vipBanner = document.getElementById("vip-banner");
    
    if (isVIP) {
      vipContent.style.display = "block";
      vipLocked.style.display = "none";
      vipBanner.style.display = "block";
    } else {
      vipContent.style.display = "none";
      vipLocked.style.display = "block";
      vipBanner.style.display = "none";
    }
  }

  function getStatusLabel(status) {
    const statusMap = {
      'PendingPayment': 'Pending Payment',
      'Paid': 'Payment Confirmed',
      'Rejected_Insufficient_Funds': 'Payment Failed',
      'Queued_For_Preparation': 'Waiting for Chef',
      'In_Preparation': 'Preparing',
      'On_Hold': 'On Hold',
      'Ready_For_Delivery': 'Ready',
      'Awaiting_Pickup': 'Awaiting Pickup',
      'Out_For_Delivery': 'Out for Delivery',
      'Completed': 'Delivered',
      'Delivery_Failed': 'Delivery Failed'
    };
    return statusMap[status] || status;
  }

  function loadOrderHistory() {
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn !== "true") {
      document.getElementById("orders-section").style.display = "none";
      return;
    }

    const userId = localStorage.getItem("userId");
    const API_URL = "http://127.0.0.1:5000";
    
    fetch(`${API_URL}/api/orders/history/${userId}`)
      .then(res => res.json())
      .then(orders => {
        const ordersSection = document.getElementById("orders-section");
        const ordersList = document.getElementById("orders-list");
        const noOrders = document.getElementById("no-orders");
        
        if (!Array.isArray(orders) || orders.length === 0) {
          ordersSection.style.display = "block";
          ordersList.innerHTML = "";
          noOrders.style.display = "block";
          return;
        }
        
        ordersSection.style.display = "block";
        noOrders.style.display = "none";
        
        ordersList.innerHTML = orders.map(order => `
          <div class="order-card">
            <div class="order-header">
              <div class="order-id">Order #${String(order.id).slice(-6).toUpperCase()}</div>
              <div class="order-status ${order.status.toLowerCase()}">${getStatusLabel(order.status)}</div>
            </div>
            <div class="order-details">
              <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleDateString()}</p>
              <p><strong>Total:</strong> $${order.final_price.toFixed(2)}</p>
              <p><strong>Status:</strong> ${order.status}</p>
              <p><strong>Updated:</strong> ${new Date(order.created_at).toLocaleTimeString()}</p>
            </div>
            <div class="order-items-list">
              <strong>Items (${order.items.length}):</strong>
              <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #666;">
                ${order.items.map(item => `<li>${item.dish_name} x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}</li>`).join('')}
              </ul>
              ${order.discount_applied > 0 ? `<p style="margin: 8px 0 0 0; font-size: 12px; color: #ff6b6b;">VIP Discount Applied: -$${order.discount_applied.toFixed(2)}</p>` : ''}
            </div>
          </div>
        `).join("");
      })
      .catch(err => {
        console.error("Error loading orders:", err);
        document.getElementById("orders-section").style.display = "none";
      });
  }

  updateCartCount();
  updateAuthStatus();
  checkVIPAccess();
  loadOrderHistory();
  loadFeaturedDishes();

  /* UC-05: Visitor Menu Browsing */
  async function loadVisitorMenu() {
    try {
      const response = await fetch(`${API_URL}/api/visitor/menu`);
      if (!response.ok) {
        console.error("Error loading visitor menu:", response.statusText);
        return;
      }
      
      const data = await response.json();
      const dishes = data.menu || [];
      
      const menuGrid = document.getElementById("visitor-menu-grid");
      const noMenu = document.getElementById("no-menu");
      const visitorSection = document.getElementById("visitor-menu-section");
      
      if (dishes.length === 0) {
        menuGrid.innerHTML = "";
        noMenu.style.display = "block";
        return;
      }
      
      noMenu.style.display = "none";
      menuGrid.innerHTML = dishes.map(dish => `
        <div class="menu-card">
          <img src="${dish.image_url || 'images/default-dish.jpeg'}" alt="${dish.name}">
          <h3>${dish.name}</h3>
          <p>${dish.description}</p>
          <div class="dish-info">
            <span class="time">${dish.preparation_time}</span>
            <span class="available">${dish.available ? 'Available' : 'Out of Stock'}</span>
          </div>
          <span class="price">$${dish.price.toFixed(2)}</span>
          <div class="card-actions">
            <button onclick="viewDishDetails('${dish.id}')" class="btn-secondary">View Details</button>
          </div>
        </div>
      `).join("");
      
      visitorSection.style.display = "block";
    } catch (error) {
      console.error("Error loading visitor menu:", error);
    }
  }

  function viewDishDetails(dishId) {
    // Open a modal or navigate to dish details page
    // Placeholder for now
    alert(`Viewing details for dish: ${dishId}`);
  }

  // UC-05 A1: Handle registration attempt
  function showRegistrationPrompt() {
    const message = "Register now to place orders, track deliveries, and enjoy VIP benefits!";
    const response = confirm(message + "\n\nClick OK to go to registration.");
    if (response) {
      window.location.href = "register.html";
    }
  }

  // UC-05: Search and filter menu
  function filterMenu() {
    const searchBox = document.getElementById("search-box").value.toLowerCase();
    const categoryFilter = document.getElementById("category-filter").value;
    const cards = document.querySelectorAll(".menu-card");
    
    cards.forEach(card => {
      const name = card.querySelector("h3").textContent.toLowerCase();
      const desc = card.querySelector("p").textContent.toLowerCase();
      
      const matchesSearch = name.includes(searchBox) || desc.includes(searchBox);
      const matchesCategory = !categoryFilter || 
        (card.dataset.category && card.dataset.category === categoryFilter);
      
      card.style.display = (matchesSearch && matchesCategory) ? "block" : "none";
    });
  }

  // UC-05: Initialize menu links
  document.getElementById("menu-link").onclick = function(e) {
    e.preventDefault();
    loadVisitorMenu();
    document.getElementById("visitor-menu-section").scrollIntoView({ behavior: 'smooth' });
  };

  document.getElementById("chat-link").onclick = function(e) {
    e.preventDefault();
    window.location.href = "chat.html";
  };

  // Update cart link visibility based on login status
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
  const cartLink = document.getElementById("cart-link");
  if (!isLoggedIn) {
    cartLink.onclick = function(e) {
      e.preventDefault();
      showRegistrationPrompt();
    };
  }

  // Add event listeners for search and filter
  const searchBox = document.getElementById("search-box");
  const categoryFilter = document.getElementById("category-filter");
  if (searchBox) searchBox.addEventListener("input", filterMenu);
  if (categoryFilter) categoryFilter.addEventListener("change", filterMenu);

  // Show visitor menu on page load for non-logged-in users
  if (!isLoggedIn) {
    loadVisitorMenu();
  }
</script>

</body>
</html>