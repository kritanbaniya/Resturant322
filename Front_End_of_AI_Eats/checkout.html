<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Eats - Checkout</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1>AI Eats</h1>
    <nav>
      <div class="nav-left">
        <a href="login.html" id="auth-link">Login/Register</a>
      </div>
      <div class="nav-center">
        <a href="index.html">Home</a>
        <a href="menu.html">Menu</a>
        <a href="chat.html">AI Chat</a>
      </div>
      <div class="nav-right">
        <a href="cart.html"> Cart (<span id="cart-count">0</span>)</a>
      </div>
    </nav>
  </header>

  <!-- CHECKOUT SECTION -->
  <section class="checkout-section">
    <div class="checkout-container">
      <h2> Checkout</h2>
      
      <div class="checkout-content">
        <!-- ORDER SUMMARY -->
        <div class="order-summary">
          <h3>Order Summary</h3>
          <div id="checkout-items"></div>
          <div class="summary-totals">
            <div class="summary-row">
              <span>Subtotal</span>
              <span id="checkout-subtotal">$0.00</span>
            </div>
            <div class="summary-row">
              <span>Delivery Fee</span>
              <span>$2.99</span>
            </div>
            <div class="summary-row">
              <span>Tax</span>
              <span id="checkout-tax">$0.00</span>
            </div>
            <div class="summary-row total-row">
              <span>Total</span>
              <span id="checkout-total">$0.00</span>
            </div>
          </div>

          <!-- BALANCE CHECK -->
          <div class="balance-check" id="balance-check">
            <h4>[BALANCE] Account Balance</h4>
            <div class="balance-info">
              <div class="balance-row">
                <span>Available Balance:</span>
                <span id="available-balance" style="font-weight: bold; color: #2e7d32;">$0.00</span>
              </div>
              <div class="balance-row">
                <span>Order Total:</span>
                <span id="order-total-check" style="font-weight: bold;">$0.00</span>
              </div>
              <div id="balance-warning" style="display: none;">
                <p style="color: #d32f2f; margin: 10px 0 0 0; padding: 10px; background: #ffebee; border-radius: 4px;">
                  [WARNING] <strong>Insufficient Balance!</strong> Your balance is insufficient for this order. Please deposit more funds in your profile.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- CHECKOUT FORM -->
        <div class="checkout-form">
          <form id="checkout-form">
            <h3>Delivery Information</h3>
            <div class="form-group">
              <label for="full-name">Full Name *</label>
              <input type="text" id="full-name" required>
            </div>
            
            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" required>
            </div>
            
            <div class="form-group">
              <label for="address">Delivery Address *</label>
              <textarea id="address" rows="3" required></textarea>
            </div>

            <h3>Payment Information</h3>
            <div class="form-group">
              <label for="card-number">Card Number *</label>
              <input type="text" id="card-number" placeholder="1234 5678 9012 3456" required>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="expiry">Expiry Date *</label>
                <input type="text" id="expiry" placeholder="MM/YY" required>
              </div>
              <div class="form-group">
                <label for="cvv">CVV *</label>
                <input type="text" id="cvv" placeholder="123" required>
              </div>
            </div>

            <div class="form-group">
              <label for="card-name">Name on Card *</label>
              <input type="text" id="card-name" required>
            </div>

            <div class="form-group">
              <label for="special-instructions">Special Instructions</label>
              <textarea id="special-instructions" rows="2" placeholder="Any special delivery instructions..."></textarea>
            </div>

            <button type="submit" class="place-order-btn">Place Order</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <p>&copy; 2025 AI Eats. All rights reserved.</p>
  </footer>

  <script>
    const API_URL = "http://127.0.0.1:5000";

    function loadCheckoutSummary() {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      let container = document.getElementById("checkout-items");
      
      if (cart.length === 0) {
        window.location.href = "cart.html";
        return;
      }
      
      container.innerHTML = "";
      let subtotal = 0;
      
      cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        container.innerHTML += `
          <div class="checkout-item">
            <img src="${item.image}" alt="${item.name}">
            <div class="item-info">
              <h4>${item.name}</h4>
              <span>Qty: ${item.quantity}</span>
            </div>
            <span class="item-price">$${itemTotal.toFixed(2)}</span>
          </div>
        `;
      });
      
      const isVIP = localStorage.getItem("isVIP") === "true";
      let finalSubtotal = subtotal;
      
      if (isVIP) {
        finalSubtotal = subtotal * 0.9;
      }
      
      const deliveryFee = isVIP ? 0 : 2.99;
      const tax = finalSubtotal * 0.08;
      const total = finalSubtotal + deliveryFee + tax;
      
      document.getElementById("checkout-subtotal").textContent = `$${finalSubtotal.toFixed(2)}`;
      if (isVIP && subtotal !== finalSubtotal) {
        document.getElementById("checkout-subtotal").innerHTML += ' <span class="vip-discount">(10% VIP discount applied)</span>';
      }
      
      const deliveryElement = document.querySelector('.summary-row:nth-child(2) span:last-child');
      deliveryElement.textContent = isVIP ? 'FREE (VIP)' : '$2.99';
      
      document.getElementById("checkout-tax").textContent = `$${tax.toFixed(2)}`;
      document.getElementById("checkout-total").textContent = `$${total.toFixed(2)}`;
      document.getElementById("order-total-check").textContent = `$${total.toFixed(2)}`;
      
      // Load and check balance
      checkBalance(total);
    }

    async function checkBalance(orderTotal) {
      const userId = localStorage.getItem("userId");
      
      try {
        const response = await fetch(`${API_URL}/api/users/${userId}`);
        if (response.ok) {
          const userData = await response.json();
          const balance = userData.balance;
          
          document.getElementById("available-balance").textContent = `$${balance.toFixed(2)}`;
          const warningEl = document.getElementById("balance-warning");
          const placeOrderBtn = document.querySelector(".place-order-btn");
          
          // UC-01 Precondition: Must have positive balance
          if (balance <= 0) {
            warningEl.innerHTML = '<p style="color: #d32f2f; margin: 10px 0 0 0; padding: 10px; background: #ffebee; border-radius: 4px;">[WARNING] <strong>No Balance!</strong> You must deposit funds before ordering. Please visit your profile to deposit money.</p>';
            warningEl.style.display = "block";
            placeOrderBtn.disabled = true;
            placeOrderBtn.style.opacity = "0.5";
            placeOrderBtn.textContent = "Deposit Funds Required";
          } else if (balance < orderTotal) {
            // UC-01 A1: Insufficient funds warning
            warningEl.innerHTML = '<p style="color: #d32f2f; margin: 10px 0 0 0; padding: 10px; background: #ffebee; border-radius: 4px;">[WARNING] <strong>Insufficient Balance!</strong> Your balance is insufficient for this order. <strong>WARNING:</strong> Attempting to place this order will result in a warning on your account.</p>';
            warningEl.style.display = "block";
            placeOrderBtn.disabled = true;
            placeOrderBtn.style.opacity = "0.5";
            placeOrderBtn.textContent = "Insufficient Balance - Deposit Funds";
          } else {
            warningEl.style.display = "none";
            placeOrderBtn.disabled = false;
            placeOrderBtn.style.opacity = "1";
            placeOrderBtn.textContent = "Place Order";
          }
        }
      } catch (error) {
        console.error("Error checking balance:", error);
      }
    }

    function updateCartCount() {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById("cart-count").textContent = totalItems;
    }

    function updateAuthStatus() {
      const isLoggedIn = localStorage.getItem("isLoggedIn");
      const username = localStorage.getItem("username");
      const isVIP = localStorage.getItem("isVIP") === "true";
      const authLink = document.getElementById("auth-link");
      
      if (isLoggedIn === "true" && username) {
        const vipIcon = isVIP ? "[VIP] " : "";
        authLink.textContent = `[USER] ${vipIcon}${username}`;
        authLink.href = "profile.html";
      } else {
        authLink.textContent = "Login/Register";
        authLink.href = "login.html";
      }
    }

    document.getElementById("checkout-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      const submitBtn = document.querySelector(".place-order-btn");
      submitBtn.textContent = "Processing...";
      submitBtn.disabled = true;
      
      try {
        const userId = localStorage.getItem("userId");
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        
        const items = cart.map(item => ({
          dish_id: item.id,
          quantity: item.quantity
        }));
        
        console.log("Cart items to send:", JSON.stringify(cart, null, 2));
        console.log("Formatted items for API:", JSON.stringify(items, null, 2));
        console.log("User ID:", userId);
        
        const requestBody = {
          customer_id: userId,
          items: items
        };
        
        console.log("Full request body:", JSON.stringify(requestBody, null, 2));
        
        const response = await fetch(`${API_URL}/api/orders/create`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (response.ok) {
          const orderId = data.order_id;
          
          // Confirm the order (process payment and move to kitchen queue)
          const confirmResponse = await fetch(`${API_URL}/api/orders/confirm/${orderId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            }
          });
          
          const confirmData = await confirmResponse.json();
          
          if (confirmResponse.ok) {
            // UC-01 A2: Check for VIP upgrade
            if (confirmData.vip_upgraded) {
              localStorage.setItem("isVIP", "true");
              alert("[CONGRATS] Congratulations! You've been upgraded to VIP status!\n\nEnjoy 10% discounts and free delivery on all future orders!");
            }
            
            // Update balance in localStorage if provided
            if (confirmData.new_balance !== undefined) {
              // Fetch updated user data to sync balance
              const userResponse = await fetch(`${API_URL}/api/users/${userId}`);
              if (userResponse.ok) {
                const userData = await userResponse.json();
                localStorage.setItem("balance", userData.balance);
              }
            }
            
            const orderData = {
              orderId: orderId,
              username: localStorage.getItem("username"),
              items: cart,
              total: document.getElementById("checkout-total").textContent,
              customerInfo: {
                name: document.getElementById("full-name").value,
                phone: document.getElementById("phone").value,
                address: document.getElementById("address").value
              },
              orderDate: new Date().toISOString(),
              status: "confirmed"
            };
            
            let orders = JSON.parse(localStorage.getItem("orders")) || [];
            orders.push(orderData);
            localStorage.setItem("orders", JSON.stringify(orders));
            
            localStorage.removeItem("cart");
            
            localStorage.setItem("lastOrder", JSON.stringify(orderData));
            window.location.href = "order-confirmation.html";
          } else {
            const errorMsg = confirmData.error || "Failed to confirm order";
            
            // UC-01 A1: Insufficient funds error with warning applied
            if (errorMsg.includes("Insufficient funds") || errorMsg.includes("Insufficient")) {
              alert("[ERROR] ORDER REJECTED - INSUFFICIENT FUNDS\n\n" +
                    "Required: $" + (confirmData.required || "N/A") + "\n" +
                    "Your Balance: $" + (confirmData.balance || "N/A") + "\n\n" +
                    "[WARNING] WARNING APPLIED: You have received a warning for attempting to place an order without sufficient funds.\n\n" +
                    "Please deposit more funds in your profile before trying again.\n\n" +
                    "Note: 3 warnings will result in account deregistration (VIPs: 2 warnings = VIP status loss).");
            } else {
              alert("Error confirming order: " + errorMsg);
            }
            console.error("Confirm error:", JSON.stringify(confirmData, null, 2));
            submitBtn.textContent = "Place Order";
            submitBtn.disabled = false;
          }
        } else {
          const errorMsg = data.error || data.details || "Unknown error";
          const submitBtn = document.querySelector(".place-order-btn");
          
          // UC-01 Preconditions: Check for balance/login errors
          if (errorMsg.includes("positive balance")) {
            alert("[ERROR] NO BALANCE\n\nYou must deposit funds before placing an order.\n\nPlease visit your profile to deposit money.");
            submitBtn.textContent = "Deposit Funds Required";
            submitBtn.disabled = true;
          } else if (errorMsg.includes("Customer or VIP")) {
            alert("[ERROR] UNAUTHORIZED\n\nOnly customers can place orders. Please log in with a customer account.");
          } else if (errorMsg.includes("not active")) {
            alert("[ERROR] ACCOUNT INACTIVE\n\nYour account is not active. Please contact support.");
          } else {
            alert("Error creating order: " + errorMsg);
          }
          
          console.error("Order error full response:", JSON.stringify(data, null, 2));
          submitBtn.textContent = "Place Order";
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Error connecting to server. Please try again.");
        submitBtn.textContent = "Place Order";
        submitBtn.disabled = false;
      }
    });

    loadCheckoutSummary();
    updateCartCount();
    updateAuthStatus();
  </script>
</body>
</html>