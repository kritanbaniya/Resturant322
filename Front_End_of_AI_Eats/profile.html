<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Eats - Profile</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1>AI Eats</h1>
    <nav>
      <div class="nav-left">
        <a href="profile.html" id="auth-link">ðŸ‘¤ Profile</a>
      </div>
      <div class="nav-center">
        <a href="index.html">Home</a>
        <a href="menu.html">Menu</a>
        <a href="chat.html">AI Chat</a>
      </div>
      <div class="nav-right">
        <a href="cart.html">ðŸ›’ Cart (<span id="cart-count">0</span>)</a>
      </div>
    </nav>
  </header>

  <!-- PROFILE SECTION -->
  <section class="profile-section">
    <div class="profile-container">
      <div class="profile-header">
        <div class="profile-avatar">ðŸ‘¤</div>
        <h2 id="profile-username">Loading...</h2>
        <p id="profile-email">Loading...</p>
      </div>

      <div class="profile-content">
        <div class="profile-card">
          <h3>Account Information</h3>
          <div class="info-row">
            <span class="label">Username:</span>
            <span id="display-username">-</span>
          </div>
          <div class="info-row">
            <span class="label">Email:</span>
            <span id="display-email">-</span>
          </div>
          <div class="info-row">
            <span class="label">Member Since:</span>
            <span id="member-since">-</span>
          </div>
          <div class="info-row">
            <span class="label">Account Status:</span>
            <span class="status-active">Active</span>
          </div>
          <div class="info-row">
            <span class="label">Membership:</span>
            <span id="membership-status">Regular</span>
          </div>
        </div>

        <div class="profile-card">
          <h3>Order History</h3>
          <div id="order-history">
            <p class="no-orders">No orders yet. <a href="menu.html">Start ordering!</a></p>
          </div>
        </div>

        <div class="profile-card">
          <h3>Account Actions</h3>
          <div class="action-buttons">
            <a href="vip-membership.html" class="btn-vip" id="vip-action-btn">Upgrade to VIP</a>
            <button class="btn-secondary" onclick="editProfile()">Edit Profile</button>
            <button class="btn-danger" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <p>&copy; 2025 AI Eats. All rights reserved.</p>
  </footer>

  <script>
    const API_URL = "http://127.0.0.1:5000";

    async function loadProfile() {
      const username = localStorage.getItem("username");
      const email = localStorage.getItem("email");
      const userId = localStorage.getItem("userId");
      const isLoggedIn = localStorage.getItem("isLoggedIn");

      // Redirect if not logged in
      if (isLoggedIn !== "true" || !username) {
        window.location.href = "login.html";
        return;
      }

      // Update profile information
      document.getElementById("profile-username").textContent = username;
      document.getElementById("profile-email").textContent = email || "Not provided";
      document.getElementById("display-username").textContent = username;
      document.getElementById("display-email").textContent = email || "Not provided";
      
      // Set member since date (using current date as placeholder)
      const memberSince = localStorage.getItem("memberSince") || new Date().toLocaleDateString();
      localStorage.setItem("memberSince", memberSince);
      document.getElementById("member-since").textContent = memberSince;

      // Fetch user data from backend if userId is available
      if (userId) {
        try {
          const response = await fetch(`${API_URL}/api/users/${userId}`);
          if (response.ok) {
            const userData = await response.json();
            // Update profile with backend data
            localStorage.setItem("userBalance", userData.balance);
            localStorage.setItem("totalSpent", userData.totalSpent);
            localStorage.setItem("orderCount", userData.orderCount);
          }
        } catch (error) {
          console.error("Error fetching user data:", error);
        }
      }

      loadOrderHistory();
      updateVIPStatus();
      updateCartCount();
      updateAuthStatus();
    }

    function editProfile() {
      alert("Edit profile feature coming soon!");
    }

    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("username");
        localStorage.removeItem("email");
        localStorage.removeItem("password");
        localStorage.removeItem("userId");
        window.location.href = "index.html";
      }
    }

    function updateCartCount() {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById("cart-count").textContent = totalItems;
    }

    async function loadOrderHistory() {
      const userId = localStorage.getItem("userId");
      const currentUsername = localStorage.getItem("username");
      const orderHistoryContainer = document.getElementById("order-history");
      
      try {
        // Try to fetch from backend first
        if (userId) {
          const response = await fetch(`${API_URL}/api/orders/history/${userId}`);
          if (response.ok) {
            const orders = await response.json();
            if (orders.length > 0) {
              orderHistoryContainer.innerHTML = orders.map(order => `
                <div class="order-item">
                  <div class="order-header">
                    <span class="order-id">Order #${order.id || order.order_id}</span>
                    <span class="order-date">${new Date(order.order_date).toLocaleDateString()}</span>
                  </div>
                  <div class="order-details">
                    <div class="order-status">Status: ${order.status}</div>
                    <div class="order-total">Total: ${order.total}</div>
                  </div>
                </div>
              `).join('');
              return;
            }
          }
        }
      } catch (error) {
        console.error("Error fetching order history:", error);
      }
      
      // Fallback to localStorage
      const allOrders = JSON.parse(localStorage.getItem("orders")) || [];
      const userOrders = allOrders.filter(order => order.username === currentUsername);
      
      if (userOrders.length === 0) {
        orderHistoryContainer.innerHTML = '<p class="no-orders">No orders yet. <a href="menu.html">Start ordering!</a></p>';
        return;
      }
      
      orderHistoryContainer.innerHTML = userOrders.map(order => `
        <div class="order-item">
          <div class="order-header">
            <span class="order-id">Order #${order.orderId}</span>
            <span class="order-date">${new Date(order.orderDate).toLocaleDateString()}</span>
          </div>
          <div class="order-details">
            <div class="order-items">
              ${order.items.map(item => `<span>${item.name} x${item.quantity}</span>`).join(', ')}
            </div>
            <div class="order-total">${order.total}</div>
          </div>
          <div class="order-status">Status: ${order.status}</div>
        </div>
      `).join('');
    }

    function updateVIPStatus() {
      const isVIP = localStorage.getItem("isVIP") === "true";
      const membershipStatus = document.getElementById("membership-status");
      const vipActionBtn = document.getElementById("vip-action-btn");
      
      if (isVIP) {
        membershipStatus.innerHTML = '<span class="vip-status">ðŸ‘‘ VIP Member</span>';
        vipActionBtn.textContent = "Manage VIP";
        vipActionBtn.href = "vip-membership.html";
      } else {
        membershipStatus.textContent = "Regular";
        vipActionBtn.textContent = "Upgrade to VIP";
        vipActionBtn.href = "vip-membership.html";
      }
    }

    function updateAuthStatus() {
      const username = localStorage.getItem("username");
      const isVIP = localStorage.getItem("isVIP") === "true";
      const authLink = document.getElementById("auth-link");
      
      if (username) {
        const vipIcon = isVIP ? "ðŸ‘‘ " : "";
        authLink.textContent = `ðŸ‘¤ ${vipIcon}${username}`;
        authLink.href = "profile.html";
      }
    }

    // Load profile on page load
    loadProfile();
  </script>
</body>
</html>